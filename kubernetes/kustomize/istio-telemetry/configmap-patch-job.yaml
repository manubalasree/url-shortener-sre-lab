apiVersion: batch/v1
kind: Job
metadata:
  name: istio-mesh-config-patcher
  namespace: istio-system
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      serviceAccountName: istio-mesh-config-patcher
      restartPolicy: Never
      containers:
      - name: kubectl
        image: bitnami/kubectl:latest
        command:
        - /bin/sh
        - -c
        - |
          kubectl patch configmap istio -n istio-system --type=json -p='[
            {
              "op": "add",
              "path": "/data/mesh",
              "value": "defaultConfig:\n  discoveryAddress: istiod.istio-system.svc:15012\n  tracing:\n    sampling: 100.0\n    max_path_tag_length: 256\n    zipkin:\n      address: jaeger-collector.observability.svc.cluster.local:9411\ndefaultProviders:\n  metrics:\n  - prometheus\nenablePrometheusMerge: true\nrootNamespace: istio-system\ntrustDomain: cluster.local\nextensionProviders:\n- name: jaeger\n  zipkin:\n    service: jaeger-collector.observability.svc.cluster.local\n    port: 9411\n    maxTagLength: 256\n- name: envoy\n  envoyFileAccessLog:\n    path: /dev/stdout\n"
            }
          ]'
          echo "Istio mesh config patched successfully"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: istio-mesh-config-patcher
  namespace: istio-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: istio-mesh-config-patcher
  namespace: istio-system
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "patch"]
  resourceNames: ["istio"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: istio-mesh-config-patcher
  namespace: istio-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: istio-mesh-config-patcher
subjects:
- kind: ServiceAccount
  name: istio-mesh-config-patcher
  namespace: istio-system
